{% extends "layout.html" %}

{% block title %}
    Index
{% endblock %}

{% block main %}
<form action="/" method="post">
    <div>
        <div class="row" >
            <div class="col">
                <input type="text" class="form-control" placeholder="Product Name" name = "product_name">
            </div>
            <div class="col">
                <select class="form-control" name="product_type">
                    <option>Product_Type: No Selection</option>
                    <option>Furniture</option>
                    <option>Foods</option>
                    <option>Books</option>
                    <option>Kitchen</option>
                    <option>Others</option>
                </select>
            </div>
            <div class="col">
                <input type="text" class="form-control" placeholder="University/College Name*" name = "university" id = "university">
                <ul id = "list" style="font-size: 10px;"></ul>
            </div>
            <div class="col">
                <input type="text" class="form-control" placeholder="Address *" name = "address">
                <ul id = "listaddress" style="font-size: 10px;"></ul>
            </div>
            <div class="col">
                <select class="form-control" name="priceselect">
                    <option>Price: Default</option>
                    <option>$0-20</option>
                    <option>$20-$100</option>
                    <option>$100+</option>
                </select>
            </div>
            <div class="col">
                <button class="btn btn-primary" type="submit" name="search">Filter</button>
            </div>
        </div>
    </div>
</form>
<div class = "small-container">
    <h2 class = "title">All Products</h2>
    <div>
        <select id="activitySelector">
            <option>Default</option>
            <option>Sort by Price (Low to High)</option>
            <option>Sort by Price (High to Low)</option>
        </select>
    </div>
    <br>
    <br>
    <div id = "product-list" class = 'row'>
        {% for row in row_sell %}
            <form action="/cart" method="post" class = "col-4 shadow p-3 mb-5 bg-body rounded">
                <input name="product_id" type="hidden" value="{{ row['id'] }}">
                <img style="height:200px;" src = "{{'../static/profile_pics/' ~ row['image'] }}" alt = "">
                <h4>
                    <a href='{{url_for("product", product_id = row["id"]) }}'>{{row['name']}}</a>
                </h4>
                <p>{{row['price']|usd}}</p>
                <button class="btn btn-outline-danger btn-rounded btn-sm" type="submit" name="add">Add to Cart</button>
            </form>
        {% endfor %}
    </div>

</div>

<script>
    let input_u = document.querySelector('#university');
    input_u.addEventListener('input', async function(){
        let response_u = await fetch('/searchuniversity?q=' + input_u.value);
        let university = await response_u.json();
        let html_title = '';
        let html_address = '';

        for (let id in university){
            let title = university[id].name;
            let address = university[id].address;
            html_title += '<li>' + title + '</li>';
            html_address  += '<li>' + address + '</li>';
        }
        document.querySelector('#list').innerHTML = html_title;
        document.querySelector('#listaddress').innerHTML = html_address;
    });
    function sortByProperty(property){
        return function(a,b){
            if(a[property] > b[property])
                return 1;
            else if(a[property] < b[property])
                return -1;

            return 0;
        }
    }
    let input = document.querySelector('#activitySelector');
    input.addEventListener('change', async function(){
        let html_sort = '';
        // let row = {{row_sell|tojson}};
        let row = {{ row_sell|safe }};
        let sort_row = '';
        if(input.value == 'Sort by Price (Low to High)')
        {
            sort_row = row.slice().sort((a, b) => a.price - b.price);
            console.log(sort_row);
        }
        else if(input.value == 'Sort by Price (High to Low)')
        {
            sort_row = row.slice().sort((a, b) => b.price - a.price);
            console.log(sort_row);
        }
        else
        {
            sort_row = row;
            console.log(sort_row);
        }
        for(let i in sort_row){
            let title = sort_row[i].name;
            let price = sort_row[i].price.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            let image = "../static/profile_pics/" + sort_row[i].image;
            let id_name = sort_row[i]["id"];
            let url_html = '<a href= {{url_for("product", product_id = "id_name")}}>' + title + '</a>';
            console.log(url_html);
            let final_html = url_html.replace('id_name', id_name);
            html_sort += '<form action="/cart" method="post" class = "col-4 shadow p-3 mb-5 bg-body rounded"> <img style="height:200px;" src = ' + image + ' alt = ""> <h4>'+ final_html+ '</h4> <p>' + price +' </p><button class="btn btn-outline-danger btn-rounded btn-sm" type="submit" name="add">Add to Cart</button></form>';
        }
        document.querySelector('#product-list').innerHTML = html_sort;
    });
</script>
{% endblock %}